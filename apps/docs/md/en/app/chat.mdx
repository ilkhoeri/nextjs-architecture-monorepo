---
title: Chat Page
---

# Chat Page

---

The `chat` page serves as the main user interface for communication through the **instant messaging** feature. Each user can:

- Create a **group chat**, with a minimum of 2 members (no maximum member limit currently).
- Start a private conversation (direct chat) with other users, without having to go through a group.

The interface and features are designed to resemble the **WhatsApp Messenger** application, intended for user familiarity, including element placement, colors, icons, and interaction flows.

---

## Realtime Messaging

The **realtime chat** feature is built using [`pusher-js`](https://pusher.com/), which allows:

- New messages to appear instantly in real-time **without needing to reload the page**.
- Detection of other users' online status (**online presence**).
- **Read status** notifications, i.e., knowing who has read the message.

Although still in its early stages and not yet reaching the level of perfection of `WhatsApp`, `Telegram`, or `Discord`, this implementation already includes basic functionalities that are quite representative and can be further developed.

---

## Chat Editor

For the message editor, instead of using a `<textarea>` element for typing messages, the editor is designed using a custom-developed `<div contentEditable />` element.

> Main reference and inspiration: [Lexical by Meta](https://lexical.dev/)

Features of this editor include:

- Token-based text processing.
- Support for **semi-Markdown** like WhatsApp and Discord.
- User **mention** feature (e.g., `@username`).
- Auto-linking for typed URLs.
- Auto-emoji (e.g., `:smile:` becomes ðŸ˜„).
- Text is still stored as **pure string** in the database (not serialized tokens or AST).

Although not fully stable, this approach is a lightweight and reliable alternative to partially replace `lexical`. The `MessageBubble` component is used to render stored messages, and [tokenization](/concept/tokenization) occurs only during rendering, not during storage.

To maintain content security, all messages are sanitized using [`domPurify`](https://www.npmjs.com/package/dompurify) before being sent to the database and before being rendered.

---

## Optimistic UI & Message Status

This system uses an **Optimistic UI** approach to keep user interactions fast and responsive, even with slow networks. Messages will appear instantly in the UI while waiting for confirmation from the server.

---

### Message Status

```ts
type $Enums.MessageStatus = "SENDING" | "SENT" | "FAILED" | "SEEN";
```

### Client Handler

```ts
function useOptimisticMessages(
  chatId: string,
  params: OptimisticMessagesParams
): {
  sendMessage: (value: SendMessage) => Promise<void>;
  retrySend: (msg: OptimisticMessage) => Promise<void>;
  deleteMessage: (messageId: string) => Promise<void>;
};
```

With this approach:

- Messages appear as if they have been sent -> (`SENDING`).
- If successfully confirmed by the server -> status becomes `SENT`.
- If it fails (e.g., due to network) -> status becomes `FAILED` and the user can press "Retry".
- If read by other users -> status is updated to `SEEN`.

---

## `[chatId]`

The page with the `[chatId]` parameter is used to display **all conversations** from a specific chat session (both personal and group).

---

### Process & Data Types

1. All chat data is retrieved as `Chat[]` from the database.
2. Data is filtered by `chatId`.
3. Each message is then converted to the `EnrichedMessage` type with additional metadata:

```ts
interface EnrichedMessage extends OptimisticMessage {
  isFirst: boolean;
  isLast: boolean;
  isFirstInDay: boolean;
  isLastInDay: boolean;
  isRepeat: boolean;
  isFromCurrentUser: boolean;
  dayKey: string;
  groupPosition: GroupPosition;
  isEdited: boolean;
  totalCount: number;
  indexKey: number;
}
```

### Properties:

- `isFirst` / `isLast`: markers for the beginning or end of a group of messages.
- `isFirstInDay` / `isLastInDay`: used to insert dividers based on date.
- `isRepeat`: whether the identical message has appeared before.
- `isFromCurrentUser`: distinguishes the bubble position for messages from the current user.
- `groupPosition`: detects the bubble position for grouping (top/middle/bottom).
- `isEdited`: flag if the message has been edited.
- `totalCount`: total messages in a specific session.
- `indexKey`: logical order used when rendering or grouping messages.

---

## Security & Sanitization

- Before messages are rendered, all text inputs are sanitized using [`domPurify`](https://www.npmjs.com/package/dompurify).
- [Tokenization](/concept/tokenization) is performed during rendering to support features like mentions, emojis, and inline styling.
- To prevent abuse, overly long strings are truncated, and dangerous symbols (such as HTML tags, event listeners, etc.) are sterilized.
